<?php

/**
 * Created by PhpStorm.
 * User: Chubs
 * Date: 12/6/2016
 * Time: 6:32 AM
 */
class content
{
    public function __construct()
    {
        $this->webdb = new website_connection();
    }
    public function GetContent($arg) {
        switch($arg) {
            case "title": $this->GetTitle(PageTitle()); break;
            case "body":  $this->GetBody(PageTitle()); break;
        }
    }
    public function GetTitle($ident) {
        $query = <<<SQL
        SELECT title FROM pages WHERE ident = :ident
SQL;
        $resource = $this->webdb->db->prepare( $query );
            $resource->execute( array (
                ":ident"    => $ident,
            ));
            if($resource->rowCount() == 0 ) {
                echo "Load 404";
            } else {
                $result = $resource->fetch(PDO::FETCH_ASSOC);
                if(is_callable($result['title'])) {
                 echo $result['title'](); }
                else {
                    echo $result['title'];
                }
            }

    }
    public function GetBody($ident) {
        $query = <<<SQL
        SELECT body FROM pages WHERE ident = :ident
SQL;
        $resource = $this->webdb->db->prepare( $query );
            $resource->execute( array (
                ":ident"    => $ident,
            ));
            if($resource->rowCount() == 0) {
                echo "Load 404";
            } else {
                $result = $resource->fetch(PDO::FETCH_ASSOC);
                if(is_callable($result['body'])) {
                    echo $result['body']();
                } else {
                    echo $result['body'];
                }
            }
    }
    public function CreateNavigation($menuName, $access) {
        $query = <<<SQL
        SELECT ident,title,span FROM pages WHERE menu = :menuname AND access = :access
SQL;
        $resource = $this->webdb->db->prepare( $query );
            $resource->execute( array (
                ":menuname" => $menuName,
                ":access"   => $access,
            ));
            foreach($resource as $row) {
                if($row['ident'] == PageTitle()) {
                    $class = "active";
                } else { $class = ""; }
                if($this->HasChildren($row['ident']) == false) {
                    if(is_callable($row['title'])) {
                        echo "<li class = '" . $class . "'><a href='" . $row['ident'] . "'><i class='fa fa-".$row['span']."'></i> " . $row['title']() . "</a></li>";

                    } else {
                        echo "<li class = '" . $class . "'><a href='" . $row['ident'] . "'><i class='fa fa-".$row['span']."'></i> " . $row['title'] . "</a></li>";
                    }
                } else {
                    echo '<li class="dropdown">';
                    if(is_callable($row['title'])) {
                        echo '<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="fa fa-'.$row['span'].'"></i> ' . $row['title']() . ' <span class="caret"></span></a>';
                    }
                    else {
                        echo '<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="fa fa-'.$row['span'].'"></i> '.$row['title'].' <span class="caret"></span></a>';
                    }
                    echo '<ul class="dropdown-menu">';
                    $this->GetChildren($row['ident']);
                    echo '</ul>';
                echo '</li>';
                }
            }
    }
    public function GetChildren($ident) {
        $query = <<<SQL
        SELECT ident,title,span FROM pages WHERE parent = :ident
SQL;
        $resource = $this->webdb->db->prepare( $query );
            $resource->execute( array (
                ":ident"    => $ident,
            ));
            foreach($resource as $row) {
                if(is_callable($row['title'])) {
                    echo "<li><a href='".$row['ident']."'> ".$row['title']()."</a></li>";
                } else {
                    echo "<li><a href='".$row['ident']."'> ".$row['title']."</a></li>";
                }
            }
    }
    public function HasChildren($ident) {
        $query = <<<SQL
        SELECT ident FROM pages WHERE parent = :ident
SQL;
        $resource = $this->webdb->db->prepare( $query );
            $resource->execute( array (
                ":ident"    => $ident,
            ));
            if($resource->rowCount() == 0 ) {
                return false;
            } else {
                return true;
            }

    }
    public function ReturnPageTitle() {
        $query = <<<SQL
      SELECT title FROM pages WHERE ident = :pageTitle
SQL;
        $resource = $this->webdb->db->prepare( $query );
            $resource->execute( array (
                ":pageTitle"    => PageTitle(),
            ));
            if($resource->rowCount() == 0 ) {
                return "Page Not Found";
                //Todo Create Custom 404 Header
            } else {
                $result = $resource->fetch(PDO::FETCH_ASSOC);
                if(is_callable($result['title'])) {
                    return $result['title']();
                } else {
                    return $result['title'];
                }
            }

    }
}
